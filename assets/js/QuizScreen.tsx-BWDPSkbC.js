import{j as e,r as t,m as s,A as a,R as i}from"./chunk-DQeWIckh.js";import{u as n,R as r,S as l,F as o,T as c,U as d}from"./index-BWNHgHBc.js";import{a as u,K as m}from"./chunk-BKk1XnZc.js";import{M as h,a as x}from"./chunk-CITm0nqS.js";import"./chunk-BI3NJeJA.js";import"./chunk-MJnNx1Rr.js";import"./chunk-BGx2W5xE.js";class p{static instance;audioContext=null;speechSynthesis=null;audioBuffers=new Map;settings={soundEnabled:!0,effectsVolume:.5,speechRate:1,speechPitch:1};isSpeaking=!1;constructor(){"undefined"!=typeof window&&(("AudioContext"in window||"webkitAudioContext"in window)&&(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),"speechSynthesis"in window&&(this.speechSynthesis=window.speechSynthesis))}static getInstance(){return p.instance||(p.instance=new p),p.instance}updateSettings(e){this.settings={...this.settings,...e}}getSettings(){return{...this.settings}}async speak(e,t){if(this.speechSynthesis&&this.settings.soundEnabled)return this.stopSpeaking(),new Promise(s=>{const a=new SpeechSynthesisUtterance(e),i=this.speechSynthesis.getVoices().find(e=>"ja-JP"===e.lang||e.lang.startsWith("ja"));i&&(a.voice=i),a.rate=t?.rate||this.settings.speechRate||1,a.pitch=t?.pitch||this.settings.speechPitch||1,a.volume=this.settings.effectsVolume,a.onend=()=>{this.isSpeaking=!1,this.currentUtterance=null,t?.onEnd?.(),s()},a.onerror=e=>{this.isSpeaking=!1,this.currentUtterance=null,s()},this.currentUtterance=a,this.isSpeaking=!0,this.speechSynthesis.speak(a)});t?.onEnd?.()}stopSpeaking(){this.speechSynthesis&&this.isSpeaking&&(this.speechSynthesis.cancel(),this.isSpeaking=!1,this.currentUtterance=null)}getIsSpeaking(){return this.isSpeaking}async playSound(e){if(!this.audioContext||!this.settings.soundEnabled)return;"suspended"===this.audioContext.state&&await this.audioContext.resume();const t=this.audioContext.currentTime,s=this.audioContext.createOscillator(),a=this.audioContext.createGain();switch(s.connect(a),a.connect(this.audioContext.destination),e){case"correct":s.frequency.setValueAtTime(523.25,t),s.frequency.exponentialRampToValueAtTime(1046.5,t+.15),a.gain.setValueAtTime(.3*this.settings.effectsVolume,t),a.gain.exponentialRampToValueAtTime(.01,t+.3),s.start(t),s.stop(t+.3);break;case"incorrect":s.frequency.setValueAtTime(300,t),s.frequency.exponentialRampToValueAtTime(150,t+.2),a.gain.setValueAtTime(.2*this.settings.effectsVolume,t),a.gain.exponentialRampToValueAtTime(.01,t+.3),s.start(t),s.stop(t+.3);break;case"levelUp":[523.25,659.25,783.99,1046.5].forEach((e,s)=>{const a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.connect(i),i.connect(this.audioContext.destination),a.frequency.setValueAtTime(e,t+.1*s),i.gain.setValueAtTime(.3*this.settings.effectsVolume,t+.1*s),i.gain.exponentialRampToValueAtTime(.01,t+.1*s+.4),a.start(t+.1*s),a.stop(t+.1*s+.4)});break;case"achievement":for(let e=0;e<3;e++){const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.connect(a),a.connect(this.audioContext.destination),s.frequency.setValueAtTime(800+200*e,t+.05*e),s.type="sine",a.gain.setValueAtTime(.1*this.settings.effectsVolume,t+.05*e),a.gain.exponentialRampToValueAtTime(.01,t+.05*e+.2),s.start(t+.05*e),s.stop(t+.05*e+.2)}break;case"monsterGet":[523.25,659.25,523.25,783.99].forEach((e,s)=>{const a=this.audioContext.createOscillator(),i=this.audioContext.createGain();a.connect(i),i.connect(this.audioContext.destination),a.frequency.setValueAtTime(e,t+.15*s),i.gain.setValueAtTime(.25*this.settings.effectsVolume,t+.15*s),i.gain.exponentialRampToValueAtTime(.01,t+.15*s+.1),a.start(t+.15*s),a.stop(t+.15*s+.1)});break;case"click":s.frequency.setValueAtTime(1e3,t),a.gain.setValueAtTime(.1*this.settings.effectsVolume,t),a.gain.exponentialRampToValueAtTime(.01,t+.05),s.start(t),s.stop(t+.05);break;case"hover":s.frequency.setValueAtTime(600,t),s.type="sine",a.gain.setValueAtTime(.05*this.settings.effectsVolume,t),a.gain.exponentialRampToValueAtTime(.01,t+.1),s.start(t),s.stop(t+.1)}}dispose(){this.stopSpeaking(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioBuffers.clear()}}const g=p.getInstance();function f(){const{progressManager:e}=n(),[s,a]=t.useState(!1),i=e.getSettings();t.useEffect(()=>{g.updateSettings({soundEnabled:i.soundEnabled,effectsVolume:i.effectsVolume})},[i.soundEnabled,i.effectsVolume]);const r=t.useCallback(async(e,t)=>{if(i.soundEnabled){a(!0);try{await g.speak(e,{...t,onEnd:()=>{a(!1),t?.onEnd?.()}})}catch(s){a(!1)}}},[i.soundEnabled]),l=t.useCallback(()=>{g.stopSpeaking(),a(!1)},[]),o=t.useCallback(async e=>{if(i.soundEnabled)try{await g.playSound(e)}catch(t){}},[i.soundEnabled]),c=t.useCallback(t=>{e.updateSettings({effectsVolume:t}),g.updateSettings({effectsVolume:t})},[e]),d=t.useCallback(()=>{const t=!i.soundEnabled;e.updateSettings({soundEnabled:t}),g.updateSettings({soundEnabled:t}),!t&&s&&l()},[i.soundEnabled,e,s,l]);return t.useEffect(()=>()=>{l()},[l]),{speak:r,stopSpeaking:l,isSpeaking:s,playSound:o,isEnabled:i.soundEnabled,volume:i.effectsVolume,updateVolume:c,toggleSound:d}}const b=i.memo(({question:t})=>e.jsx("div",{className:"bg-white rounded-lg shadow-md p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"問題"}),e.jsx("p",{className:"text-xl text-gray-700 leading-relaxed whitespace-pre-line",children:t.question})]})})),y=i.memo(({choices:a,onSelect:i,selectedAnswer:n,correctAnswer:r,isAnswered:l})=>{const{playSound:o}=f(),c=t.useRef(null);t.useEffect(()=>{if(l)return;const e=e=>{if(!c.current)return;const t=c.current.querySelectorAll("button:not([disabled])"),s=Array.from(t).findIndex(e=>e===document.activeElement);if(e.key>="1"&&e.key<="4"){const t=parseInt(e.key)-1;return void(t<a.length&&(e.preventDefault(),i(t),u(`選択肢${t+1}を選択しました: ${a[t]}`)))}switch(e.key){case m.ARROW_UP:case m.ARROW_LEFT:e.preventDefault(),s>0?t[s-1].focus():t[t.length-1].focus();break;case m.ARROW_DOWN:case m.ARROW_RIGHT:e.preventDefault(),s<t.length-1?t[s+1].focus():t[0].focus()}};return c.current?.addEventListener("keydown",e),()=>c.current?.removeEventListener("keydown",e)},[a,i,l]),t.useEffect(()=>{if(l&&null!==n){const e=n===r?`正解です！正解は${a[r]}でした。`:`不正解です。正解は${a[r]}でした。`;u(e,"assertive")}},[l,n,r,a]);const d=e=>l?e===r?"bg-green-100 border-2 border-green-500":e===n&&e!==r?"bg-red-100 border-2 border-red-500":"bg-gray-100 border-2 border-gray-300 opacity-50":"bg-white hover:bg-blue-50 border-2 border-gray-300 hover:border-blue-400";return e.jsx("div",{ref:c,className:"grid grid-cols-1 md:grid-cols-2 gap-4",role:"group","aria-label":"選択肢",children:a.map((t,a)=>{const c=String.fromCharCode(65+a);return e.jsxs(s.button,{onClick:()=>{l||(o("click"),i(a))},disabled:l,className:`p-4 rounded-lg text-left transition-all ${d(a)} ${l?"cursor-not-allowed":"cursor-pointer"}`,whileHover:l?{}:{scale:1.02},whileTap:l?{}:{scale:.98},"aria-label":`選択肢${c}: ${t}`,"aria-pressed":n===a,"aria-describedby":l&&a===r?`correct-${a}`:l&&a===n&&a!==r?`incorrect-${a}`:void 0,children:[e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-semibold mr-3","aria-hidden":"true",children:c}),e.jsx("span",{className:"text-gray-800",children:t})]}),l&&a===r&&e.jsxs(e.Fragment,{children:[e.jsx(s.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-2 -right-2 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white","aria-hidden":"true",children:"✓"}),e.jsx("span",{id:`correct-${a}`,className:"sr-only",children:"正解"})]}),l&&a===n&&a!==r&&e.jsxs(e.Fragment,{children:[e.jsx(s.div,{initial:{scale:0},animate:{scale:1},className:"absolute -top-2 -right-2 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white","aria-hidden":"true",children:"✗"}),e.jsx("span",{id:`incorrect-${a}`,className:"sr-only",children:"不正解"})]})]},a)})})}),j=i.memo(({comboState:i,comboBonus:n,showBreakAnimation:l=!1})=>{const[o,c]=t.useState(!1);if(t.useEffect(()=>{if(n.message){c(!0);const e=setTimeout(()=>c(!1),2e3);return()=>clearTimeout(e)}},[n.message,i.currentCombo]),0===i.currentCombo&&!l)return null;return e.jsxs("div",{className:"fixed top-20 right-4 z-40",children:[e.jsxs(a,{children:[i.currentCombo>0&&e.jsxs(s.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0},transition:{type:"spring",stiffness:300,damping:20},className:"relative",children:[e.jsx("div",{className:`\n              bg-gradient-to-r rounded-lg shadow-lg p-4 min-w-[150px] text-center\n              ${"super_fire"===n.effectType?"from-red-500 to-orange-500":"fire"===n.effectType?"from-orange-400 to-yellow-500":"from-blue-400 to-purple-500"}\n            `,children:e.jsxs(s.div,{initial:{scale:1.5},animate:{scale:1},transition:{type:"spring",stiffness:200},className:"text-white",children:[e.jsx("div",{className:"text-sm font-bold opacity-90",children:"COMBO"}),e.jsx("div",{className:"text-4xl font-bold",children:i.currentCombo}),n.experienceMultiplier>1&&e.jsxs("div",{className:"text-sm mt-1",children:["EXP x",n.experienceMultiplier]})]},i.currentCombo)}),i.isOnFire&&e.jsx("div",{className:"absolute -top-2 left-1/2 transform -translate-x-1/2 flex gap-1",children:[...Array("super_fire"===n.effectType?3:"fire"===n.effectType?2:1)].map((t,a)=>e.jsx(s.div,{"data-testid":"fire-icon",initial:{y:0},animate:{y:[-5,-10,-5]},transition:{duration:.5,repeat:1/0,delay:.1*a,ease:"easeInOut"},children:e.jsx(r,{className:`\n                        ${"super_fire"===n.effectType?"text-red-500":"text-orange-500"}\n                      `,size:20+2*a})},a))}),i.currentCombo%5==0&&i.currentCombo>0&&e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:[...Array(6)].map((t,a)=>e.jsx(s.div,{className:"absolute top-1/2 left-1/2 w-2 h-2 bg-yellow-300 rounded-full",initial:{x:0,y:0,opacity:1},animate:{x:50*Math.cos(a/6*Math.PI*2),y:50*Math.sin(a/6*Math.PI*2),opacity:0},transition:{duration:1,ease:"easeOut"}},a))})]}),e.jsx(a,{children:o&&n.message&&e.jsx(s.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},exit:{y:-20,opacity:0},className:"absolute top-full mt-2 left-1/2 transform -translate-x-1/2 whitespace-nowrap",children:e.jsx("div",{className:`\n                px-4 py-2 rounded-full font-bold text-white shadow-lg\n                ${"super_fire"===n.effectType?"bg-gradient-to-r from-red-500 to-pink-500":"fire"===n.effectType?"bg-gradient-to-r from-orange-500 to-yellow-500":"bg-gradient-to-r from-blue-500 to-purple-500"}\n              `,children:n.message})})}),l&&e.jsx(s.div,{initial:{scale:1,opacity:1},animate:{scale:1.5,opacity:0},transition:{duration:.5},className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"text-red-500 font-bold text-xl",children:"COMBO BREAK"})})]}),i.currentCombo>0&&i.lastCorrectTime&&e.jsx(s.div,{initial:{opacity:0},animate:{opacity:1},className:"mt-2 w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx(s.div,{className:"h-full bg-gradient-to-r from-green-400 to-blue-400",initial:{width:"100%"},animate:{width:"0%"},transition:{duration:30,ease:"linear"}})})]})});i.memo(h);const w=i.memo(({progress:t})=>{const a=t.getLevelProgress(),i=a.progressPercentage;return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600 mb-1",children:[e.jsx("span",{children:"経験値"}),e.jsxs("span",{children:[a.currentExp," / ",a.expForNext]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 overflow-hidden",children:e.jsx(s.div,{className:"h-full bg-gradient-to-r from-blue-400 to-blue-600",initial:{width:0},animate:{width:`${i}%`},transition:{duration:.5,ease:"easeOut"}})})]})}),N=({monster:t,isNew:a,reward:i,onCollect:n})=>e.jsxs(s.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:"bg-white rounded-lg shadow-lg p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-4",children:a?"モンスターゲット！":"すでに持っているモンスター"}),e.jsxs(s.div,{initial:{y:-20},animate:{y:0},transition:{type:"spring",stiffness:200},className:"relative inline-block",children:[e.jsx("div",{className:"w-32 h-32 mb-4",children:e.jsx(x,{monster:t,size:128,className:"mx-auto",showAnimation:!0})}),e.jsx(s.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.3},className:"absolute -top-2 -right-2",children:e.jsx("div",{className:"bg-yellow-400 rounded-full p-2",children:e.jsx("span",{className:"text-2xl",children:"⭐"})})})]}),e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:t.name}),e.jsx("p",{className:`inline-block px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r ${{common:"from-gray-400 to-gray-600",rare:"from-blue-400 to-blue-600",epic:"from-purple-400 to-purple-600",legendary:"from-yellow-400 to-yellow-600"}[t.rarity]} text-white mb-4`,children:{common:"コモン",rare:"レア",epic:"エピック",legendary:"レジェンダリー"}[t.rarity]}),e.jsxs("p",{className:"text-gray-600 mb-4",children:["「",t.sourceContent.text,"」から生まれたモンスター"]}),!a&&i&&e.jsxs(s.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"bg-gray-100 rounded-lg p-4 mb-4",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"代わりに以下の報酬を獲得："}),e.jsxs("div",{className:"flex justify-center items-center space-x-4",children:[e.jsx("div",{className:"flex items-center space-x-1",children:e.jsxs("span",{className:"text-green-500 font-semibold",children:["+",i.experience," EXP"]})}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(l,{className:"text-yellow-500"}),e.jsxs("span",{className:"text-yellow-600 font-semibold",children:["+",i.coins]})]})]})]}),e.jsx(s.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:n,className:"px-8 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-shadow",children:a?"コレクションに追加する":"次の問題へ"})]}),v=()=>{const{currentQuestion:i,currentMonster:l,monsterGenerationResult:u,levelUpResult:m,lastQuizResult:h,newAchievements:x,isAnswered:p,selectedAnswer:g,showExplanation:v,submitAnswer:k,nextQuestion:C,collectMonster:S,clearNotifications:A,progressManager:T}=n(),E=T.getProgress(),V=T.getComboState(),R=T.getComboBonus(),{speak:O,stopSpeaking:$,isSpeaking:M,playSound:q,isEnabled:P}=f(),[B,U]=t.useState(!1);return t.useEffect(()=>{if(m||x.length>0){const e=setTimeout(()=>{A()},5e3);return()=>clearTimeout(e)}},[m,x,A]),t.useEffect(()=>(i&&!p&&P&&O(i.question),()=>{$()}),[i,p,P,O,$]),t.useEffect(()=>{p&&h&&(q(h.isCorrect?"correct":"incorrect"),!h.isCorrect&&V.currentCombo>0&&(U(!0),setTimeout(()=>U(!1),1e3)))},[p,h,q,V.currentCombo]),t.useEffect(()=>{m&&q("levelUp")},[m,q]),t.useEffect(()=>{x.length>0&&q("achievement")},[x,q]),i?e.jsxs("main",{className:"space-y-6 relative",role:"main","aria-label":"クイズ画面",children:[e.jsx(j,{comboState:V,comboBonus:R,showBreakAnimation:B}),e.jsxs(a,{children:[m&&e.jsx(s.div,{initial:{opacity:0,y:-50},animate:{opacity:1,y:0},exit:{opacity:0,y:-50},className:"fixed top-20 left-1/2 transform -translate-x-1/2 z-50",role:"alert","aria-live":"polite",children:e.jsx("div",{className:"bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-lg shadow-lg",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(o,{className:"text-2xl","aria-hidden":"true"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-lg",children:"レベルアップ！"}),e.jsxs("p",{className:"text-sm",children:["レベル ",m.newLevel," に到達しました！"]})]})]})})}),x.map((t,a)=>e.jsx(s.div,{initial:{opacity:0,x:300},animate:{opacity:1,x:0},exit:{opacity:0,x:300},transition:{delay:.2*a},className:"fixed top-32 right-4 z-50",style:{top:128+80*a+"px"},role:"alert","aria-live":"polite",children:e.jsxs("div",{className:"bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg shadow-lg",children:[e.jsxs("p",{className:"font-bold",children:[e.jsx("span",{"aria-hidden":"true",children:"🏆"})," 実績解除！"]}),e.jsx("p",{className:"text-sm",children:t.name})]})},t.id))]}),e.jsxs("section",{className:"bg-white rounded-lg shadow-md p-6","aria-label":"進捗情報",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["レベル ",E.level]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["正解数: ",E.totalCorrect," / ",E.totalQuestions]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"連続正解"}),e.jsxs("div",{className:"flex items-center justify-end space-x-1",children:[e.jsx("p",{className:"text-2xl font-bold text-orange-500",children:E.currentStreak}),e.jsx(r,{className:"text-orange-500 text-xl","aria-hidden":"true"})]})]})]}),e.jsx(w,{progress:T})]}),e.jsxs("section",{className:"relative","aria-label":"問題",children:[e.jsx(b,{question:i}),P&&e.jsx("button",{onClick:t.useCallback(()=>{M?$():O(i.question)},[M,$,O,i]),className:"absolute top-4 right-4 p-2 rounded-full bg-blue-100 hover:bg-blue-200 transition-colors","aria-label":M?"読み上げを停止":"問題を読み上げる",children:M?e.jsx(c,{className:"text-blue-600 text-xl"}):e.jsx(d,{className:"text-blue-600 text-xl"})})]}),e.jsx(y,{choices:i.choices,onSelect:k,selectedAnswer:g,correctAnswer:i.correctAnswer,isAnswered:p}),v&&e.jsxs(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"rounded-lg p-6 "+(g===i.correctAnswer?"bg-green-50 border-2 border-green-300":"bg-red-50 border-2 border-red-300"),children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:g===i.correctAnswer?"正解！":"不正解..."}),e.jsx("p",{className:"text-gray-700 whitespace-pre-line",children:i.explanation}),h?.isCorrect&&e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["獲得経験値: +",10+Math.min(2*E.currentStreak,20)," EXP",E.currentStreak>1&&e.jsxs("span",{className:"text-orange-500 ml-2",children:["(ストリークボーナス +",Math.min(2*E.currentStreak,20),")"]})]})})]}),u&&l&&e.jsx(N,{monster:l,isNew:!u.isDuplicate,reward:u.reward,onCollect:t.useCallback(()=>{S(),q("monsterGet"),C()},[S,q,C])}),p&&!l&&e.jsx("div",{className:"text-center",children:e.jsx("button",{onClick:t.useCallback(()=>{q("click"),C()},[q,C]),className:"px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors",children:"次の問題へ"})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"問題を読み込んでいます..."})]})};export{v as QuizScreen};
