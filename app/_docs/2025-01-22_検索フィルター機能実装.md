# 2025-01-22 検索・フィルター機能実装

## 概要
「ことだまモンスタークイズ」プロジェクトに検索・フィルター機能を実装しました。これにより、ユーザーはモンスターコレクションや学習コンテンツを効率的に検索・絞り込みできるようになりました。

## 実装内容

### 1. SearchManager の実装
**ファイル**: `src/core/SearchManager.ts`

#### 主な機能
- **テキスト検索**: 部分一致、前方一致、完全一致に対応
- **ひらがな・カタカナ正規化**: 「さる」「サル」など表記揺れに対応
- **スコアリング**: 検索精度に基づいた結果の順位付け
- **複数フィールド検索**: テキスト、読み仮名、意味での検索
- **サジェスト機能**: 入力中の候補表示

#### 検索オプション
```typescript
interface SearchOptions {
  query: string;
  contentTypes?: Array<'proverb' | 'idiom' | 'four_character_idiom'>;
  difficulties?: Array<'小学生' | '中学生' | '高校生'>;
  includeReadings?: boolean;
  includeMeanings?: boolean;
}
```

#### フィルターオプション
```typescript
interface FilterOptions {
  contentTypes?: Array<'proverb' | 'idiom' | 'four_character_idiom'>;
  difficulties?: Array<'小学生' | '中学生' | '高校生'>;
  rarities?: Array<'common' | 'rare' | 'epic' | 'legendary'>;
  unlocked?: boolean | null;
  favorite?: boolean;  // 将来実装用
}
```

### 2. 検索UIコンポーネント

#### SearchBar コンポーネント
**ファイル**: `src/components/common/SearchBar.tsx`

- **リアルタイム検索**: デバウンス処理（300ms）で負荷軽減
- **サジェスト表示**: 最大5件の候補を表示
- **キーボード操作**: 矢印キーでサジェスト選択、Escでクリア
- **アクセシビリティ**: ARIAラベル、role属性を適切に設定
- **ダークモード対応**: テーマに応じた色調整

#### FilterPanel コンポーネント
**ファイル**: `src/components/common/FilterPanel.tsx`

- **アコーディオン形式**: セクションごとに開閉可能
- **複数条件の組み合わせ**: AND条件でフィルタリング
- **アクティブフィルター表示**: 適用中のフィルター数を表示
- **一括クリア機能**: すべてのフィルターをリセット

### 3. 既存画面への統合

#### MonsterCollection の更新
**ファイル**: `src/components/monster/MonsterCollection.tsx`

変更内容：
- 検索バーの追加
- フィルターパネルの統合
- 検索結果のハイライト表示
- 検索クエリの表示
- 空の状態の改善（検索結果なし時のメッセージ）

#### StatsScreen の更新
**ファイル**: `src/components/stats/StatsScreen.tsx`

変更内容：
- コンテンツ検索セクションの追加
- 検索結果の一覧表示
- フィルター機能の統合

#### MonsterCard の更新
**ファイル**: `src/components/monster/MonsterCard.tsx`

変更内容：
- `highlighted` プロパティの追加
- 検索でヒットしたカードの視覚的強調
- ring効果による目立たせ

### 4. ユーティリティフック

#### useDebounce フック
**ファイル**: `src/hooks/useDebounce.ts`

- 検索入力の遅延処理
- パフォーマンス最適化

### 5. テスト実装

#### SearchManager のテスト
**ファイル**: `tests/core/SearchManager.test.ts`

テストケース：
- 空クエリの処理
- 完全一致・部分一致検索
- ひらがな・カタカナ正規化
- フィルター機能
- スコアリング順序
- サジェスト機能
- マッチ位置情報

## 技術的な工夫

### 1. パフォーマンス最適化
- デバウンス処理による検索頻度の制限
- useMemoによる不要な再計算の防止
- アニメーションのdelay制限（最大0.5秒）

### 2. ユーザビリティ
- リアルタイム検索で即座にフィードバック
- キーボード操作の完全サポート
- 検索状態の視覚的フィードバック

### 3. アクセシビリティ
- スクリーンリーダー対応
- キーボードナビゲーション
- 適切なARIA属性

### 4. 拡張性
- お気に入り機能の準備
- 新しいフィルター条件の追加が容易
- 検索アルゴリズムの改善余地

## 使用例

### モンスターコレクションでの検索
1. 検索バーに「猿」と入力
2. 「猿も木から落ちる」に関連するモンスターが表示
3. レアリティや取得状況でさらに絞り込み

### 統計画面でのコンテンツ検索
1. 「失敗」というキーワードで検索
2. 関連することわざ・慣用句が一覧表示
3. 難易度やタイプでフィルタリング

## 今後の拡張可能性

1. **高度な検索オプション**
   - AND/OR検索
   - 除外検索（NOT）
   - 正規表現検索

2. **検索履歴**
   - 最近の検索を記録
   - よく使う検索条件の保存

3. **お気に入り機能との連携**
   - お気に入りのみ検索
   - お気に入りへの一括追加

4. **検索結果のエクスポート**
   - 検索結果をCSV出力
   - 学習リストの作成

## まとめ

この実装により、「ことだまモンスタークイズ」のユーザビリティが大幅に向上しました。特に：

- **効率的なコンテンツ探索**: 1000件以上のコンテンツから目的のものを素早く発見
- **学習効率の向上**: 苦手分野や特定難易度の問題に集中
- **コレクション管理**: モンスターの検索・整理が容易に

検索・フィルター機能は、アプリケーションの規模が大きくなるほど重要になる機能であり、今回の実装はユーザー体験の向上に大きく貢献します。